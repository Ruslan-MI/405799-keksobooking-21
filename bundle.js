(()=>{"use strict";window.const={PinSize:{WIDTH:50,HEIGHT:70},MainPinSize:{WIDTH:65,HEIGHT:65,SPIKE_HEIGHT:16},StatusCode:{OK:200},TIMEOUT_IN_MS:1e4,Url:{DOWNLOAD:"https://21.javascript.pages.academy/keksobooking/data",UPLOAD:"https://21.javascript.pages.academy/keksobooking"},CoordsLimit:{MIN_X:0,MIN_Y:130,MAX_Y:630},MAX_PINS_QUANTITY:5,DEBOUNCE_INTERVAL:500,FILE_TYPES:["gif","jpg","jpeg","png"]},window.preview={start:(e,t)=>{e.addEventListener("change",(()=>{const o=e.files[0];if(window.const.FILE_TYPES.some((e=>o.type.endsWith(e)))){const e=new FileReader,n=()=>{const o=t.querySelector("img");if(o)o.src=e.result;else{const o=document.createElement("img");o.src=e.result,o.style.width=t.offsetWidth+"px",o.style.height=t.offsetHeight+"px",o.style.objectFit="cover",t.appendChild(o),t.style.overflow="hidden"}};e.addEventListener("load",n),e.readAsDataURL(o)}}))}},(()=>{const e=e=>Math.floor(Math.random()*e.length),t=(e,t)=>{Array.isArray(t)&&0===t.length?e.style.display="none":t||(e.style.display="none")},o=e=>{switch(e){case 1:return" комната";default:return" комнаты"}};window.util={getRandomIndex:e,getRandomElements:t=>{let o=[],n=Math.ceil(Math.random()*t.length);for(;o.length!==n;){let n=t[e(t)];o.includes(n)||o.push(n)}return o},addDisabledForChildren:e=>{const t=e.children;for(let e of t)e.setAttribute("disabled","")},removeDisabledForChildren:e=>{const t=e.children;for(let e of t)e.removeAttribute("disabled")},fillingCardElement:(e,o)=>{t(e,o),e.classList.contains("popup__text--price")?e.textContent=o+"₽/ночь":e.classList.contains("popup__avatar")?e.src=o:e.textContent=o},getCardCapacity:(e,n,r)=>{t(e,n),e.textContent=r?n+o(n)+" для "+r+(e=>{switch(e){case 1:return" гостя";default:return" гостей"}})(r):n+o(n)},getCardTime:(e,o,n)=>{t(e,o),e.textContent=n?"Заезд после "+o+", выезд до "+n:"Заезд после "+o},getCurrentFeatures:(e,o)=>{t(e,o),e.innerHTML="";const n=document.createDocumentFragment();o.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),n.appendChild(t)})),e.appendChild(n)},getCardPhotos:(e,o)=>{t(e,o),e.innerHTML="";const n=document.createDocumentFragment();o.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.src=e,t.style.width="45px",t.style.height="40px",t.alt="Фотография жилья",n.appendChild(t)})),e.appendChild(n)},isEnterPressed:e=>"Enter"===e.key,isEscapePressed:e=>"Escape"===e.key,isMainButtonPressed:e=>0===e.button,removeElement:e=>{e&&e.remove()}}})(),window.optimize={debounce:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),window.const.DEBOUNCE_INTERVAL)}}},(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),n=()=>{document.removeEventListener("click",r),document.removeEventListener("keydown",i),e.querySelectorAll(".modal").forEach((e=>{e.remove()}))},r=e=>{e.preventDefault(),n()},i=e=>{window.util.isEscapePressed(e)&&(e.preventDefault(),n())};window.modal={addSuccess:()=>{const o=t.cloneNode(!0);o.classList.add("modal"),e.appendChild(o),document.addEventListener("click",r),document.addEventListener("keydown",i)},addError:()=>{const t=o.cloneNode(!0),n=t.querySelector(".error__button");t.classList.add("modal"),n.addEventListener("click",r),document.addEventListener("click",r),document.addEventListener("keydown",i),e.appendChild(t)}}})(),(()=>{let e;window.move={start:(e,t)=>{e.addEventListener("mousedown",(o=>{o.preventDefault();let n={x:o.clientX,y:o.clientY};const r=o=>{o.preventDefault();const r=n.x-o.clientX,i=n.y-o.clientY;n={x:o.clientX,y:o.clientY};let d=t(),a=e.offsetLeft-r,s=e.offsetTop-i;const l=window.const.CoordsLimit.MIN_X-d.x,c=e.parentElement.offsetWidth-d.x,u=window.const.CoordsLimit.MIN_Y-d.y,p=window.const.CoordsLimit.MAX_Y-d.y;e.style.left=a<l?l+"px":a>c?c+"px":a+"px",e.style.top=s<u?u+"px":s>p?p+"px":s+"px"},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)}))},getDefaultOffsets:t=>{e={left:t.offsetLeft,top:t.offsetTop}},setDefaultOffsets:t=>{t.style.left=e.left+"px",t.style.top=e.top+"px"}}})(),(()=>{const e=(e,t,o,n,r)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{i.status===window.const.StatusCode.OK?n(i.response):r("Статус ответа: "+i.status+" "+i.statusText)})),i.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=window.const.TIMEOUT_IN_MS,i.open(e,t),i.send(o)};window.backend={load:(t,o)=>{e("GET",window.const.Url.DOWNLOAD,void 0,t,o)},save:(t,o,n)=>{e("POST",window.const.Url.UPLOAD,t,o,n)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters-container"),o=document.querySelector("#card").content.querySelector(".map__card"),n={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},r=e=>{window.util.isEscapePressed(e)&&(e.preventDefault(),i())},i=()=>{const t=e.querySelector(".map__card");t&&(t.remove(),document.removeEventListener("keydown",r),e.querySelector(".map__pin--active").classList.remove("map__pin--active"))};window.card={render:d=>{i(),e.insertBefore((e=>{const t=o.cloneNode(!0),d=t.querySelector(".popup__close");return window.util.fillingCardElement(t.querySelector(".popup__title"),e.offer.title),window.util.fillingCardElement(t.querySelector(".popup__text--address"),e.offer.address),window.util.fillingCardElement(t.querySelector(".popup__text--price"),e.offer.price),window.util.fillingCardElement(t.querySelector(".popup__type"),n[e.offer.type]),window.util.getCardCapacity(t.querySelector(".popup__text--capacity"),e.offer.rooms,e.offer.guests),window.util.getCardTime(t.querySelector(".popup__text--time"),e.offer.checkin,e.offer.checkout),window.util.getCurrentFeatures(t.querySelector(".popup__features"),e.offer.features),window.util.fillingCardElement(t.querySelector(".popup__description"),e.offer.description),window.util.getCardPhotos(t.querySelector(".popup__photos"),e.offer.photos),window.util.fillingCardElement(t.querySelector(".popup__avatar"),e.author.avatar),document.addEventListener("keydown",r),d.addEventListener("click",(()=>{i()})),t})(d),t),e.querySelector(".popup__close").focus()},remove:i}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins");window.pin={render:o=>{const n=document.createDocumentFragment();o.forEach((t=>{n.appendChild((t=>{const o=e.cloneNode(!0);return o.style.left=t.location.x-window.const.PinSize.WIDTH/2+"px",o.style.top=t.location.y-window.const.PinSize.HEIGHT+"px",o.children[0].src=t.author.avatar,o.children[0].alt=t.offer.title,o.addEventListener("click",(()=>{window.card.render(t),o.classList.add("map__pin--active")})),o})(t))})),t.appendChild(n)},remove:()=>{t.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#room_number"),o=e.querySelector("#capacity"),n=e.querySelector("#address"),r=e.querySelector("#type"),i=e.querySelector("#price"),d=e.querySelector("#timein"),a=e.querySelector("#timeout"),s=document.querySelector(".map"),l=s.querySelector(".map__pin--main"),c={bungalow:0,flat:1e3,house:5e3,palace:1e4},u=()=>{"100"===t.value?o.value="0":("100"!==t.value&&"0"===o.value||t.value<o.value)&&(o.value=t.value)};t.addEventListener("change",(()=>{u()})),o.addEventListener("change",(()=>{"0"===o.value?t.value="100":("0"!==o.value&&"100"===t.value||o.value>t.value)&&(t.value=o.value)}));const p=()=>{i.placeholder=c[r.value],i.min=c[r.value]};r.addEventListener("change",(()=>{p()}));const m=()=>{a.value=d.value};d.addEventListener("change",(()=>{m()})),a.addEventListener("change",(()=>{d.value=a.value})),window.form={getMainPinCoordinates:()=>{const e=window.const.MainPinSize.WIDTH/2;let t=window.const.MainPinSize.HEIGHT/2;return s.classList.contains("map--faded")||(t=window.const.MainPinSize.HEIGHT+window.const.MainPinSize.SPIKE_HEIGHT),n.value=Math.floor(l.offsetLeft+e)+", "+Math.floor(l.offsetTop+t),{x:e,y:t}},startValidation:()=>{u(),p(),m()}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests");let i=[];window.filter={saveAds:e=>{i=e},start:()=>i.filter((i=>{return i.offer&&(d=i,"any"===t.value||t.value===d.offer.type)&&(e=>"any"===o.value||o.value===(e=>e<1e4?"low":e>=1e4&&e<5e4?"middle":"high")(e.offer.price))(i)&&(e=>"any"===n.value||n.value===e.offer.rooms.toString())(i)&&(e=>"any"===r.value||r.value===e.offer.guests.toString())(i)&&(t=>[...e.querySelectorAll(".map__checkbox:checked")].every((e=>t.offer.features.includes(e.value))))(i);var d})).slice(0,window.const.MAX_PINS_QUANTITY)}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),o=e.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),r=n.querySelector(".ad-form__reset"),i=n.querySelector(".ad-form-header__input"),d=n.querySelector(".ad-form-header__preview"),a=d.querySelector("img"),s=n.querySelector(".ad-form__input"),l=n.querySelector(".ad-form__photo"),c=a.src,u=e=>{window.util.removeDisabledForChildren(t),window.filter.saveAds(e),window.pin.render(window.filter.start())},p=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},m=()=>{e.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),window.util.removeDisabledForChildren(n),window.form.getMainPinCoordinates(),window.backend.load(u,p),window.form.startValidation(),o.removeEventListener("mousedown",w),o.removeEventListener("keydown",f)},w=e=>{window.util.isMainButtonPressed(e)&&m()},f=e=>{window.util.isEnterPressed(e)&&m()},v=()=>{e.classList.add("map--faded"),n.reset(),t.reset(),n.classList.add("ad-form--disabled"),window.util.addDisabledForChildren(n),window.util.addDisabledForChildren(t),window.move.setDefaultOffsets(o),window.form.getMainPinCoordinates(),window.pin.remove(),window.card.remove(),a.src=c,window.util.removeElement(l.querySelector("img")),o.addEventListener("mousedown",w),o.addEventListener("keydown",f)};window.util.addDisabledForChildren(n),window.util.addDisabledForChildren(t),window.form.getMainPinCoordinates(),window.move.getDefaultOffsets(o),window.move.start(o,window.form.getMainPinCoordinates),o.addEventListener("mousedown",w),o.addEventListener("keydown",f),n.addEventListener("submit",(e=>{window.backend.save(new FormData(n),(()=>{v(),window.modal.addSuccess()}),window.modal.addError),e.preventDefault()})),r.addEventListener("click",(e=>{e.preventDefault(),n.reset(),t.reset(),v()}));const y=window.optimize.debounce((()=>{window.card.remove(),window.pin.remove(),window.pin.render(window.filter.start())}));t.addEventListener("change",y),window.preview.start(i,d),window.preview.start(s,l)})()})();