(()=>{"use strict";window.const={PIN_WIDTH:50,PIN_HEIGHT:70,MAIN_PIN_WIDTH:65,MAIN_PIN_HEIGHT:65,MAIN_PIN_SPIKE_HEIGHT:16,STATUS_CODE:{OK:200},TIMEOUT_IN_MS:1e4,URL_DOWNLOAD:"https://21.javascript.pages.academy/keksobooking/data",URL_UPLOAD:"https://21.javascript.pages.academy/keksobooking",MIN_X_COORDS:0,MIN_Y_COORDS:130,MAX_Y_COORDS:630,MAX_PINS_QUANTITY:5,DEBOUNCE_INTERVAL:500,FILE_TYPES:["gif","jpg","jpeg","png"]},(()=>{const{FILE_TYPES:e}=window.const;window.preview={getPreview:(t,o)=>{t.addEventListener("change",(()=>{const r=t.files[0];if(e.some((e=>r.type.endsWith(e)))){const e=new FileReader,t=()=>{if(o.querySelector("img"))o.querySelector("img").src=e.result;else{const t=document.createElement("img");t.src=e.result,t.style.width=o.offsetWidth+"px",t.style.height=o.offsetHeight+"px",t.style.objectFit="cover",o.appendChild(t),o.style.overflow="hidden"}};e.addEventListener("load",t),e.readAsDataURL(r)}}))}}})(),(()=>{const e=e=>Math.floor(Math.random()*e.length),t=(e,t)=>{Array.isArray(t)&&0===t.length?e.style.display="none":t||(e.style.display="none")},o=e=>{switch(e){case 1:return" комната";default:return" комнаты"}};window.util={getRandomIndex:e,getRandomElements:t=>{let o=[],r=Math.ceil(Math.random()*t.length);for(;o.length!==r;){let r=t[e(t)];o.includes(r)||o.push(r)}return o},addDisabledForChildren:e=>{const t=e.children;for(let e of t)e.setAttribute("disabled","")},removeDisabledForChildren:e=>{const t=e.children;for(let e of t)e.removeAttribute("disabled")},fillingCardElement:(e,o)=>{t(e,o),e.classList.contains("popup__text--price")?e.textContent=o+"₽/ночь":e.classList.contains("popup__avatar")?e.src=o:e.textContent=o},getCardCapacity:(e,r,n)=>{t(e,r),e.textContent=n?r+o(r)+" для "+n+(e=>{switch(e){case 1:return" гостя";default:return" гостей"}})(n):r+o(r)},getCardTime:(e,o,r)=>{t(e,o),e.textContent=r?"Заезд после "+o+", выезд до "+r:"Заезд после "+o},getCurrentFeatures:(e,o)=>{t(e,o),e.innerHTML="";const r=document.createDocumentFragment();o.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),r.appendChild(t)})),e.appendChild(r)},getCardPhotos:(e,o)=>{t(e,o),e.innerHTML="";const r=document.createDocumentFragment();o.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.src=e,t.style.width="45px",t.style.height="40px",t.alt="Фотография жилья",r.appendChild(t)})),e.appendChild(r)}}})(),(()=>{const{DEBOUNCE_INTERVAL:e}=window.const;window.debounce={debounce:t=>{let o=null;return(...r)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{t(...r)}),e)}}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error"),r=()=>{document.removeEventListener("click",n),document.removeEventListener("keydown",a),e.querySelector(".modal").remove()},n=e=>{e.preventDefault(),r()},a=e=>{"Escape"===e.key&&(e.preventDefault(),r())};window.modal={addSuccessModal:()=>{const o=t.cloneNode(!0);o.classList.add("modal"),e.appendChild(o),document.addEventListener("click",n),document.addEventListener("keydown",a)},addErrorModal:()=>{const t=o.cloneNode(!0);t.classList.add("modal"),e.appendChild(t),t.querySelector(".error__button").addEventListener("click",n),document.addEventListener("click",n),document.addEventListener("keydown",a)}}})(),(()=>{const{MIN_X_COORDS:e,MIN_Y_COORDS:t,MAX_Y_COORDS:o}=window.const;let r;window.move={getMove:(r,n)=>{r.addEventListener("mousedown",(a=>{a.preventDefault();let d={x:a.clientX,y:a.clientY};const s=a=>{a.preventDefault();const s=d.x-a.clientX,c=d.y-a.clientY;d={x:a.clientX,y:a.clientY};let l=n(),i=r.offsetLeft-s,u=r.offsetTop-c;const p=e-l.x,m=r.parentElement.offsetWidth-l.x,f=t-l.y,_=o-l.y;r.style.left=i<p?p+"px":i>m?m+"px":i+"px",r.style.top=u<f?f+"px":u>_?_+"px":u+"px"},c=e=>{e.preventDefault(),document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",c)}))},getDefaultOffsets:e=>{r={left:e.offsetLeft,top:e.offsetTop}},setDefaultOffsets:e=>{e.style.left=r.left+"px",e.style.top=r.top+"px"}}})(),(()=>{const{STATUS_CODE:e,TIMEOUT_IN_MS:t,URL_DOWNLOAD:o,URL_UPLOAD:r}=window.const,n=(o,r,n,a,d)=>{const s=new XMLHttpRequest;s.responseType="json",s.addEventListener("load",(()=>{s.status===e.OK?a(s.response):d("Статус ответа: "+s.status+" "+s.statusText)})),s.addEventListener("error",(()=>{d("Произошла ошибка соединения")})),s.addEventListener("timeout",(()=>{d("Запрос не успел выполниться за "+s.timeout+"мс")})),s.timeout=t,s.open(o,r),s.send(n)};window.backend={load:(e,t)=>{n("GET",o,void 0,e,t)},save:(e,t,o)=>{n("POST",r,e,t,o)}}})(),(()=>{const{fillingCardElement:e,getCardCapacity:t,getCardTime:o,getCurrentFeatures:r,getCardPhotos:n}=window.util,a=document.querySelector(".map"),d=document.querySelector("#card").content.querySelector(".map__card"),s={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},c=e=>{"Escape"===e.key&&(e.preventDefault(),l(),a.querySelector(".map__pin--active").focus())},l=()=>{a.querySelector(".map__card")&&(a.querySelector(".map__card").remove(),document.removeEventListener("keydown",c))};window.card={renderCard:i=>{l(),a.insertBefore((i=>{const u=d.cloneNode(!0);return e(u.querySelector(".popup__title"),i.offer.title),e(u.querySelector(".popup__text--address"),i.offer.address),e(u.querySelector(".popup__text--price"),i.offer.price),e(u.querySelector(".popup__type"),s[i.offer.type]),t(u.querySelector(".popup__text--capacity"),i.offer.rooms,i.offer.guests),o(u.querySelector(".popup__text--time"),i.offer.checkin,i.offer.checkout),r(u.querySelector(".popup__features"),i.offer.features),e(u.querySelector(".popup__description"),i.offer.description),n(u.querySelector(".popup__photos"),i.offer.photos),e(u.querySelector(".popup__avatar"),i.author.avatar),document.addEventListener("keydown",c),u.querySelector(".popup__close").addEventListener("click",(()=>{l(),a.querySelector(".map__pin--active").focus()})),u})(i),a.querySelector(".map__filters-container")),a.querySelector(".popup__close").focus(),a.querySelector(".popup__close").addEventListener("keydown",(e=>{"Tab"===e.key&&(e.preventDefault(),a.querySelector(".map__pin--active").focus())}))},removeCard:l}})(),(()=>{const{PIN_WIDTH:e,PIN_HEIGHT:t}=window.const,{renderCard:o}=window.card,r=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector(".map__pins");window.pin={renderPins:a=>{const d=document.createDocumentFragment();a.forEach((a=>{d.appendChild((a=>{const d=r.cloneNode(!0);return d.style.left=a.location.x-e/2+"px",d.style.top=a.location.y-t+"px",d.children[0].src=a.author.avatar,d.children[0].alt=a.offer.title,d.addEventListener("click",(()=>{n.querySelector(".map__pin--active")&&n.querySelector(".map__pin--active").classList.remove("map__pin--active"),d.classList.add("map__pin--active"),o(a)})),d})(a))})),n.appendChild(d)},removePins:()=>{n.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))}}})(),(()=>{const{MAIN_PIN_WIDTH:e,MAIN_PIN_HEIGHT:t,MAIN_PIN_SPIKE_HEIGHT:o}=window.const,r=document.querySelector(".ad-form"),n=r.querySelector("#room_number"),a=r.querySelector("#capacity"),d=r.querySelector("#address"),s=r.querySelector("#type"),c=r.querySelector("#price"),l=r.querySelector("#timein"),i=r.querySelector("#timeout"),u=document.querySelector(".map__pin--main"),p={bungalow:0,flat:1e3,house:5e3,palace:1e4},m=()=>{"100"===n.value?a.value="0":("100"!==n.value&&"0"===a.value||n.value<a.value)&&(a.value=n.value)};n.addEventListener("change",(()=>{m()})),a.addEventListener("change",(()=>{"0"===a.value?n.value="100":("0"!==a.value&&"100"===n.value||a.value>n.value)&&(n.value=a.value)}));const f=()=>{c.placeholder=p[s.value],c.min=p[s.value]};s.addEventListener("change",(()=>{f()}));const _=()=>{i.value=l.value};l.addEventListener("change",(()=>{_()})),i.addEventListener("change",(()=>{l.value=i.value})),window.form={getMainPinCoordinates:()=>{const r=e/2;let n=t/2;return document.querySelector(".map").classList.contains("map--faded")||(n=t+o),d.value=Math.floor(u.offsetLeft+r)+", "+Math.floor(u.offsetTop+n),{x:r,y:n}},getStartValidation:()=>{m(),f(),_()}}})(),(()=>{const{MAX_PINS_QUANTITY:e}=window.const,t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),r=t.querySelector("#housing-price"),n=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests");let d=[];window.filter={saveAds:e=>{d=e},getFilter:()=>d.filter((e=>{return e.offer&&(d=e,"any"===o.value||o.value===d.offer.type)&&(e=>"any"===r.value||r.value===(e=>e<1e4?"low":e>1e4&&e<5e4?"middle":"high")(e.offer.price))(e)&&(e=>"any"===n.value||n.value===e.offer.rooms.toString())(e)&&(e=>"any"===a.value||a.value===e.offer.guests.toString())(e)&&(e=>[...t.querySelectorAll(".map__checkbox:checked")].every((t=>e.offer.features.includes(t.value))))(e);var d})).slice(0,e)}})(),(()=>{const{addDisabledForChildren:e,removeDisabledForChildren:t}=window.util,{renderPins:o,removePins:r}=window.pin,{getMainPinCoordinates:n,getStartValidation:a}=window.form,{load:d,save:s}=window.backend,{addSuccessModal:c,addErrorModal:l}=window.modal,{getMove:i,getDefaultOffsets:u,setDefaultOffsets:p}=window.move,{removeCard:m}=window.card,{saveAds:f,getFilter:_}=window.filter,{debounce:v}=window.debounce,{getPreview:y}=window.preview,w=document.querySelector(".map"),S=w.querySelector(".map__filters"),h=w.querySelector(".map__pin--main"),E=document.querySelector(".ad-form"),g=E.querySelector(".ad-form__reset"),L=E.querySelector(".ad-form-header__input"),q=E.querySelector(".ad-form-header__preview"),C=E.querySelector(".ad-form__input"),I=E.querySelector(".ad-form__photo"),D=e=>{t(S),f(e),o(_())},T=e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},x=e=>{0!==e.button&&"Enter"!==e.key||(w.classList.remove("map--faded"),E.classList.remove("ad-form--disabled"),t(E),n(),d(D,T),a(),h.removeEventListener("mousedown",x),h.removeEventListener("keydown",x))},N=()=>{w.classList.add("map--faded"),E.reset(),S.reset(),E.classList.add("ad-form--disabled"),e(E),e(S),p(h),n(),r(),m(),h.addEventListener("mousedown",x),h.addEventListener("keydown",x)};e(E),e(S),n(),u(h),i(h,n),h.addEventListener("mousedown",x),h.addEventListener("keydown",x),E.addEventListener("submit",(e=>{s(new FormData(E),(()=>{N(),c()}),l),e.preventDefault()})),g.addEventListener("click",(e=>{e.preventDefault(),E.reset(),S.reset(),N()}));const M=v((()=>{m(),r(),o(_())}));S.addEventListener("change",M),y(L,q),y(C,I)})()})();